# デュアルバックエンド計画: 詳細設計書 (Dual Engine Architecture)

- **Project**: Corporate AI Chatbot "Thinking Partner"
- **Version**: 2.0.0 (Desktop Intelligence Era)
- **Date**: 2026-01-20
- **Author**: Lead Engineer / PM Partner

---

## 1. アーキテクチャ概要: Dual Engine Strategy

従来の「チャットボット単体構成」から、OSのようなファイル操作感を実現するための「デュアルバックエンド構成」へ移行します。

### 1.1 コンセプトモデル

Reactフロントエンドは、あたかも一つのOSのように振る舞いますが、裏側では役割の異なる2つのDifyアプリと通信します。

- **Frontend (The Face)**: macOS Sequoia / Apple Intelligence Design System (React + Framer Motion)
- **Backend A (The Brain)**: Chatflow (会話・思考・検索のみを担当)
- **Backend B (The OS)**: Workflow (ファイルアップロード・削除・一覧取得等のシステム操作を担当)

### 1.2 通信フロー図

```mermaid
graph TD
    User[User on Windows/Chrome] -->|Interaction| React[React Frontend]
    
    subgraph Frontend Logic
        Store[Zustand Store]
        Mock[Mock Service (Phase A)]
    end
    
    React -->|State Updates| Store
    
    subgraph Phase B: Dual Dify Engines
        React -->|POST /chat-messages| Brain[Backend A: Chatflow]
        React -->|POST /workflows/run| OS[Backend B: Workflow]
        
        OS -->|Tool Call| Gemini[Gemini File Search Plugin]
        Brain -->|Tool Call| Gemini
    end
    
    React -.->|Phase A Only| Mock

```

---

## 2. Phase A: Frontend Implementation (Mock-Driven)

Phase Aでは、Dify側の修正を行わず、ReactフロントエンドのUI/UX完成度を100%まで高めることに集中します。
すべてのAPIコールは `src/services/MockFileSystem.ts` によってインターセプトされ、理想的なJSONレスポンスを返します。

### 2.1 UI/UX デザイン仕様 (DESIGN_RULE.md 準拠)

#### A. Unified Sidebar & Toolbar

- **構造**: ウィンドウ左側に幅260pxのサイドバー。`backdrop-filter: blur(20px) saturate(180%)`。
- **セクション**:
  - **Traffic Lights**: ウィンドウ操作ボタン。
  - **Knowledge Stores**: ユーザーが作成した「知識の保管庫（フォルダ）」一覧。
  - **Workflow**: ファイルアップロードや検索などのアクションを実行するパネル。
  - **Settings**: API KeyやBase URLの設定。
  - **History**: チャット履歴。
- **インタラクション**:
  - ストア名をクリックすると、メインエリアのビューが「Chat Mode」から「Finder Mode」(Knowledge Finder) へ遷移。

#### B. Knowledge Finder (Main Area)

- **コンセプト**: macOSのFinderを再現。チャットボットの中に「ファイル管理アプリ」が埋め込まれている感覚。
- **View Mode**: ヘッダーのトグルボタンで切り替え。
  - **Grid View**: 白いカード (`bg-white/50`) に大きなアイコン + ファイル名。
  - **List View**: 詳細情報（サイズ、日付、メタデータ）を含むリスト。
- **Metadata Registration**:
  - 「Upload」ボタンクリック時に `MetadataWizard` が起動。
  - 3ステップ（ファイル選択 → メタデータ入力 → 確認）で、会社・部署・ファイル種別を登録。
- **Animation**:
  - Framer Motion の `layoutId` を使用し、チャットモード ⇔ Finderモードの切り替えをシームレスなモーフィングで表現。

#### C. Upload & Drag & Drop Experience

- **Knowledge Finder**:
  - 「Upload」ボタンから `MetadataWizard` を経由してアップロード。
  - **Note**: 誤操作防止のため、Finder背景への直接ドラッグ＆ドロップは無効化（Drop Zone Overlay廃止）。
- **Chat Input**:
  - チャット入力欄へのファイルドラッグ＆ドロップが可能。
  - 背景がぼやけ (`backdrop-blur`)、入力欄が強調表示されるインタラクション。

### 2.2 データ構造定義 (TypeScript Interfaces)

Backend B (Workflow) が返却すべき「理想のJSONレスポンス」を定義します。Phase Aではこの構造をMockが返します。

```typescript
// src/types/FileSystem.ts

export type FileSearchStore = {
  storeName: string; // e.g. "fileSearchStores/abc12345"
  displayName: string; // e.g. "Product Specs 2024"
  createdAt: string;
};

export type StoredFile = {
  documentId: string; // Internal ID or resource name
  displayName: string;
  mimeType: string;
  sizeBytes: number;
  createTime: string;
  state: 'ACTIVE' | 'PROCESSING' | 'FAILED';
  customMetadata: Record<string, string | number>; // keys: metadata_company, metadata_department, metadata_filetype
};

// Workflow Execution Response (Backend Bからのレスポンス想定)
export type WorkflowResponse<T> = {
  status: 'succeeded' | 'failed';
  data: {
    result: T; // JSON Object
  };
};

```

### 2.3 Mock Serviceの実装要件

`src/hooks/useGeminiFileSystem.ts` から呼び出されるモックサービスです。

- **Latency Simulation**:
  - Finderの読み込み: 500ms - 800ms (自然なロード感)
  - Upload処理: 2000ms - 4000ms (処理中のプログレスバー表示のため)
  - **Metadata Handling**: `uploadFile` 時に `customMetadata` を受け取り、保存するファイルオブジェクトに付与する。

- **Persistence (Session)**:
- ページリロードで消えても良いが、セッション中は `Map<StoreName, StoredFile[]>` で状態を保持し、アップロード直後にリストが増える挙動を再現する。

---

## 3. Phase B: Dify Backend Implementation

Phase AでUIが完成した後、実際のDifyアプリを構築・修正し、Mockを本番APIクライアントに差し替えます。

### 3.1 Backend B: "The OS" (Workflow App) の新規作成

「チャットボット」ではなく「ワークフロー」タイプで新規作成します。

#### Workflow Logic (DSL設計)

1. **Input Variables**:

- `action`: (string) "list_stores" | "list_files" | "upload" | "delete"
- `payload`: (json string) 各アクションに必要なパラメータ（storeName, fileUrl, metadata等）

1. **Nodes**:

- **Start Node**
- **JSON Parser (Code Node)**: payload 文字列をパース。
- **Router (If/Else)**: action の値で分岐。
- **Tools (Gemini File Search)**:
- Branch A: `list_stores`
- Branch B: `list_files` (ページネーション対応)
- Branch C: `upload_file`
- Branch D: `delete_file`

- **Output Formatter (Code Node)**: 最重要。ツールの実行結果（テキストや生データ）を、Phase Aで定義した `StoredFile[]` 等の純粋なJSON形式に整形するPythonコード。
- **End Node**: JSONを出力。

### 3.2 Backend A: "The Brain" (Chatflow App) の修正

既存の `AIagent_Rag_poc_copy` をスリム化します。

- **削除**: ファイルアップロード、削除、一覧表示に関する分岐ロジックを全て削除。
- **変更**: `file_search_store_name` 変数を、ユーザー入力ではなく「コンテキスト変数（フロントエンドからAPI経由で渡される変数）」として扱うように変更。
- **役割**: 純粋に「指定された `file_search_store_name` を元に search ツールを実行し、回答を生成する」ことだけに集中。

### 3.3 Frontend Integration (API Clientの切り替え)

- **API Client**:
- `DifyClient.ts` に `runWorkflow` メソッドを追加（POST /workflows/run）。

- **Hook**:
- `useGeminiFileSystem` 内の `fetchFiles` や `uploadFile` 関数の中身を、Mockから `DifyClient.runWorkflow` へ差し替え。

- **Store ID Management**:
- Backend B で取得した「現在選択中の Store ID」をReactのContextで保持し、Backend A へのチャット送信時に `inputs: { file_search_store_name: currentStoreId }` として付与する。

---

## 4. 開発ロードマップ

### Phase A: Frontend Focus (Week 1)

- **Project Setup**: 新規画面レイアウト (Unified Sidebar + Main Area) の構築。
- **Mock Logic**: `MockFileSystem` とデータ型の定義。
- **Finder UI**: Grid/List Viewの実装、Framer Motionによるアニメーション。
- **Upload UX**: `MetadataWizard` によるアップロードフローの実装。

### Phase B: Backend & Integration (Week 2)

- **Dify Backend B (Workflow)**: アプリ作成、JSON整形ロジックの実装、単体テスト。
- **Dify Backend A (Chat)**: ロジックのクリーンアップ。
- **Integration**: ReactのAPIクライアント接続、エラーハンドリング、ローディング表示の調整。
